#!/bin/bash

# Run quality checks before commit
echo "ğŸ” Running pre-commit quality checks..."

# Run linting
npm run lint:check --silent
LINT_EXIT=$?

if [ $LINT_EXIT -ne 0 ]; then
  echo "âŒ Lint checks failed. Fix issues and try again."
  echo "   Run 'npm run lint:check' for details"
  exit 1
fi

# Run tests
npm run test:check --silent
TEST_EXIT=$?

if [ $TEST_EXIT -ne 0 ]; then
  echo "âŒ Tests failed. Fix issues and try again."
  echo "   Run 'npm test' for details"
  exit 1
fi

# Check staged files count for atomic commits
STAGED_COUNT=$(git diff --cached --name-only | wc -l)
echo "ğŸ“Š Staged files: $STAGED_COUNT"

if [ "$STAGED_COUNT" -gt 3 ]; then
  echo "âš ï¸  Warning: $STAGED_COUNT files staged (recommended: 1-3 for atomic commits)"
  echo "   Consider splitting into smaller commits"
  
  # Check if we're in an interactive terminal
  if [ -t 0 ]; then
    read -p "   Continue anyway? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      echo "ğŸ“ Use 'git reset HEAD <file>' to unstage files"
      exit 1
    fi
  else
    echo "   (Non-interactive mode - continuing with $STAGED_COUNT files)"
  fi
fi

echo "âœ… All quality checks passed!"
