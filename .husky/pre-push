#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Check CI status before push
echo "üîç Checking CI status before push..."

# Get recent CI status
CI_STATUS=$(gh run list --limit 1 --json conclusion,name 2>/dev/null)

if [ $? -eq 0 ] && [ ! -z "$CI_STATUS" ]; then
  # Check if the latest run failed
  FAILED=$(echo "$CI_STATUS" | grep -c '"conclusion":"failure"')
  
  if [ "$FAILED" -gt 0 ]; then
    echo "‚ùå CI is currently failing!"
    echo ""
    echo "$CI_STATUS" | jq -r '.[] | "   Failed: \(.name)"'
    echo ""
    echo "‚ö†Ô∏è  Push blocked due to CI failures"
    echo "   Use 'git push --no-verify' to override (not recommended)"
    echo "   Or fix the CI issues first with 'npm run quality:fix'"
    exit 1
  else
    echo "‚úÖ CI is passing - proceeding with push"
  fi
else
  echo "‚ö†Ô∏è  Could not verify CI status - proceeding with push"
fi